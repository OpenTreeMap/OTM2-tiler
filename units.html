<!DOCTYPE html>

<html>
<head>
  <title>units.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="addDefaultsToFilter.html">
                  addDefaultsToFilter.js
                </a>
              
                
                <a class="source" href="config.html">
                  config.js
                </a>
              
                
                <a class="source" href="displayFiltersToWhere.html">
                  displayFiltersToWhere.js
                </a>
              
                
                <a class="source" href="filterObjectToWhere.html">
                  filterObjectToWhere.js
                </a>
              
                
                <a class="source" href="filterObjectUtils.html">
                  filterObjectUtils.js
                </a>
              
                
                <a class="source" href="filtersToTables.html">
                  filtersToTables.js
                </a>
              
                
                <a class="source" href="healthCheck.html">
                  healthCheck.js
                </a>
              
                
                <a class="source" href="makeSql.html">
                  makeSql.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="units.html">
                  units.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>units.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"underscore"</span>);

<span class="hljs-keyword">var</span> convertableFields = [<span class="hljs-string">'tree.diameter'</span>, <span class="hljs-string">'tree.height'</span>, <span class="hljs-string">'tree.canopy_height'</span>,
                         <span class="hljs-string">'plot.width'</span>, <span class="hljs-string">'plot.length'</span>, <span class="hljs-string">'bioswale.drainage_area'</span>,
                         <span class="hljs-string">'rainBarrel.capacity'</span>, <span class="hljs-string">'rainGarden.drainage_area'</span>];

<span class="hljs-keyword">var</span> unitDefaults = {
    <span class="hljs-attr">plot</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-string">'in'</span>,
        <span class="hljs-attr">length</span>: <span class="hljs-string">'in'</span>
    },
    <span class="hljs-attr">tree</span>: {
        <span class="hljs-attr">diameter</span>: <span class="hljs-string">'in'</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-string">'ft'</span>,
        <span class="hljs-attr">canopy_height</span>: <span class="hljs-string">'ft'</span>
    },
    <span class="hljs-attr">bioswale</span>: {
        <span class="hljs-attr">drainage_area</span>: <span class="hljs-string">'sq_ft'</span>
    },
    <span class="hljs-attr">rainBarrel</span>: {
        <span class="hljs-attr">capacity</span>: <span class="hljs-string">'gal'</span>
    },
    <span class="hljs-attr">rainGarden</span>: {
        <span class="hljs-attr">drainage_area</span>: <span class="hljs-string">'sq_ft'</span>
    }
};

<span class="hljs-keyword">var</span> unitConversions = {
    <span class="hljs-string">'in'</span>: {<span class="hljs-string">'in'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'ft'</span>: <span class="hljs-number">1</span> / <span class="hljs-number">12</span>, <span class="hljs-string">'cm'</span>: <span class="hljs-number">2.54</span>, <span class="hljs-string">'m'</span>: <span class="hljs-number">0.0254</span>},
    <span class="hljs-string">'ft'</span>: {<span class="hljs-string">'in'</span>: <span class="hljs-number">12</span>, <span class="hljs-string">'ft'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'cm'</span>: <span class="hljs-number">30.48</span>, <span class="hljs-string">'m'</span>: <span class="hljs-number">0.3048</span>},
    <span class="hljs-string">'lbs/year'</span>: {<span class="hljs-string">'lbs/year'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'kg/year'</span>: <span class="hljs-number">0.453592</span>},
    <span class="hljs-string">'lbs'</span>: {<span class="hljs-string">'lbs'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'kg'</span>: <span class="hljs-number">0.453592</span>},
    <span class="hljs-string">'gal'</span>: {<span class="hljs-string">'gal'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'L'</span>: <span class="hljs-number">3.785</span>},
    <span class="hljs-string">'gal/year'</span>: {<span class="hljs-string">'gal/year'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'L/year'</span>: <span class="hljs-number">3.785</span>},
    <span class="hljs-string">'kwh/year'</span>: {<span class="hljs-string">'kwh/year'</span>: <span class="hljs-number">1</span>},
    <span class="hljs-string">'sq_m'</span>: {<span class="hljs-string">'sq_m'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'sq_ft'</span>: <span class="hljs-number">10.7639</span>},
    <span class="hljs-string">'sq_ft'</span>: {<span class="hljs-string">'sq_m'</span>: <span class="hljs-number">0.0929</span>, <span class="hljs-string">'sq_ft'</span>: <span class="hljs-number">1</span>}
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFilterFactor</span>(<span class="hljs-params">instanceConfig, model, field</span>) </span>{
    <span class="hljs-keyword">var</span> unit, defaultUnit,
        factor = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (instanceConfig.value_display[model]) {
        <span class="hljs-keyword">if</span> (instanceConfig.value_display[model][field]) {
            unit = instanceConfig.value_display[model][field].units;
            defaultUnit = unitDefaults[model][field];
            factor = <span class="hljs-number">1</span> / unitConversions[defaultUnit][unit];
        }
    }
    <span class="hljs-keyword">return</span> factor;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertFilterValue</span>(<span class="hljs-params">value, factor</span>) </span>{
    <span class="hljs-keyword">if</span> (_.isObject(value)) {
        _.each([<span class="hljs-string">'MIN'</span>, <span class="hljs-string">'MAX'</span>, <span class="hljs-string">'IS'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k</span>) </span>{
            <span class="hljs-keyword">var</span> floatValue;
            <span class="hljs-keyword">if</span> (value[k]) {
                <span class="hljs-keyword">if</span> (_.isObject(value[k])) {
                    floatValue = <span class="hljs-built_in">parseFloat</span>(value[k].VALUE);
                    <span class="hljs-keyword">if</span> (_.isNumber(floatValue)) {
                        value[k].VALUE = floatValue * factor;
                    }
                } <span class="hljs-keyword">else</span> {
                    floatValue = <span class="hljs-built_in">parseFloat</span>(value[k]);
                    <span class="hljs-keyword">if</span> (_.isNumber(floatValue)) {
                        value[k] =  floatValue * factor;
                    }
                }
            }
        });
    }
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertFilterUnits</span>(<span class="hljs-params">filterObject, instanceConfig</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>if there is no unit configuration, there is no need to convert</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (instanceConfig &amp;&amp; instanceConfig.value_display) {
        _.each(_.keys(filterObject), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fieldName</span>) </span>{
            <span class="hljs-keyword">var</span> value = filterObject[fieldName];
            <span class="hljs-keyword">if</span> (_.contains(convertableFields, fieldName)) {
                <span class="hljs-keyword">var</span> model = fieldName.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>],
                    field = fieldName.substring(fieldName.indexOf(<span class="hljs-string">'.'</span>) + <span class="hljs-number">1</span>),
                    factor = getFilterFactor(instanceConfig, model, field);
                convertFilterValue(value, factor);
            }
        });
    }
    <span class="hljs-keyword">return</span> filterObject;
}

exports = <span class="hljs-built_in">module</span>.exports = {
    <span class="hljs-attr">convertFilterUnits</span>: convertFilterUnits
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
